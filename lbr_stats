#!/usr/bin/env python
# stats re path to precise events
# Author: Ahmad Yasin
# edited: Sep. 2021
#
from __future__ import print_function
__author__ = 'ayasin'

import lbr
import common as C

c = {x: 0 for x in ('sequential', 'total')}

# usage: perf script -F +brstackinsn [--xed] | ./lbr_stats [ip-of-sample=ALL]
ip = C.arg(1, 'ALL')
filter = None
if ip != 'ALL':
  filter = '%x'%int(ip, 16) #asserts in hexa
  c['ip'] = '0x'+filter

while True:
  sample = lbr.read_sample(ip_filter=filter, min_lines=2)
  if not sample: break
  assert len(sample) > 2, 'invalid sample: ' + str(sample)
  c['total'] += 1
  if not lbr.is_taken(sample[-2]): c['sequential'] += 1
  print('\n'.join(sample))

print(c, C.ratio('sequential', c), sep=', ')

