#!/usr/bin/env python2
# generate C-language kernels with ability to incorporate x86 Assembly with certain control-flow constructs
# Author: Ahmad Yasin
# edited: Feb. 2021
__author__ = 'ayasin'
__version__ = 0.4
# TODO:
# - multi-byte NOP support
#

import argparse, sys

import jumpy as J

INST_UNIQ='PAUSE'
INST_1B='NOP'
NOP10='nopw   %cs:0x0(%rax,%rax,1)'
NOP14='data16 data16 data16 data16 nopw %cs:0x0(%rax,%rax,1)'
MOVlg='movabs $0x8877665544332211, %%r8'

ap = argparse.ArgumentParser()
ap.add_argument('-n', '--num', type=int, default=3, help='# times to repeat instruction(s), aka unroll-factor')
ap.add_argument('-i', '--instruction', nargs='+', default=[INST_UNIQ])
ap.add_argument('-a', '--align' , type=int, default=0, help='in power of 2')
ap.add_argument('-o', '--offset', type=int, default=0)
ap.add_argument('mode', nargs='?', choices=['basicblock']+J.jumpy_modes, default='basicblock')
args = ap.parse_args()

def asm(x, tabs=1, spaces=8):
  print ' '*spaces + 'asm("' + '\t'*tabs + x + '");'

def jumpy(): return args.mode in J.jumpy_modes

print "// Auto-generated by %s's %s version %s invoked with:\n//  %s .\n"%(__author__, sys.argv[0].replace('./',''), str(__version__), str(args).replace('Namespace', '')) + """// Do not modify!
//
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
int main(int argc, const char* argv[])
{
    uint64_t i,n;
    if (argc<2) {
        printf("%s: missing <num-iterations> arg!\\n", argv[0]);
        exit(-1);
    }
    n= atol(argv[1]);"""
asm(INST_UNIQ, spaces=4)
if args.align: asm('.align %d'%(2 ** args.align), tabs=0)
print "    for (i=0; i<n; i++) {"
for j in range(args.num):
  if args.offset:
     for k in range(j+args.offset-1): asm(INST_1B)
  if jumpy(): asm('Lbl%05d:'%j, tabs=0)
  for inst in args.instruction:
    if inst in ['JMP', 'JL']: inst += ' Lbl%05d'%J.next(args.mode, args.num)
    asm(inst)
  if jumpy() and args.align: asm('.align %d'%(2 ** args.align), tabs=0)
if jumpy(): asm('Lbl%05d:'%args.num, tabs=0)

print """    }
    asm(".align 512; Lbl_end:");

    return 0;
}"""

